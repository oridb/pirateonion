use std

use "master.use"
use "msg.use"
use "opts.use"
use "slave.use"

const main = {args
	var cmd
	var dirs

	cmd = std.optparse(args, &[
		.argdesc = "dirs...",
		.opts = [
			[.opt='s', .desc="run in slave mode; mostly for internal use"],
			[.opt='r', .arg="remote", .desc="remote server name"]
		][:]
	])
	for opt in cmd.opts
		match opt
		| ('s', _):	opt_master = false
		| ('r', rsrv):	opt_remote = rsrv
		| _:	std.fatal("unknown cli option")
		;;
	;;

	if cmd.args.len == 0
		dirs = ["."][:]
	else
		dirs = cmd.args
	;;
	if opt_master
		master(dirs)
	else
		slave(dirs)
	;;
}

